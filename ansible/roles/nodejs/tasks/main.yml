---
- name: Install NodeSource prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Validate Node.js major version variable
  ansible.builtin.assert:
    that:
      - nodejs_major_version is defined
      - nodejs_major_version is match('^[0-9]+$')
    fail_msg: "Set nodejs_major_version in vars/group_vars as a numeric string (example: '22')."

- name: Add NodeSource keyring
  ansible.builtin.get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /etc/apt/keyrings/nodesource.asc
    mode: "0644"

- name: Add NodeSource repo (Node.js {{ nodejs_major_version }}.x)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/nodesource.asc] https://deb.nodesource.com/node_{{ nodejs_major_version }}.x nodistro main"
    filename: nodesource
    state: present

- name: Install Node.js (includes npm)
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true

- name: Verify node + npm
  ansible.builtin.command: "{{ item }}"
  loop:
    - node -v
    - npm -v
  register: node_checks
  changed_when: false

- name: Show node/npm versions
  ansible.builtin.debug:
    var: node_checks.results | map(attribute='stdout') | list
