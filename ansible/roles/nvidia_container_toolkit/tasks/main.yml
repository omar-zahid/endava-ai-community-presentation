---
- name: Install NVIDIA Container Toolkit prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true
  when: enable_nvidia_container_toolkit | bool

- name: Ensure keyring directory exists
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: "0755"
  when: enable_nvidia_container_toolkit | bool

- name: Download NVIDIA Container Toolkit GPG key
  ansible.builtin.shell: >-
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey
    | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  args:
    creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  when: enable_nvidia_container_toolkit | bool

- name: Determine NVIDIA distribution identifier
  ansible.builtin.set_fact:
    nvidia_distribution: "{{ ansible_distribution | lower }}{{ ansible_distribution_version }}"
  when: enable_nvidia_container_toolkit | bool

- name: Build NVIDIA Container Toolkit repository list
  ansible.builtin.shell: >-
    curl -fsSL https://nvidia.github.io/libnvidia-container/{{ nvidia_distribution }}/libnvidia-container.list
    | sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g'
  register: nvidia_repo_list
  changed_when: false
  when: enable_nvidia_container_toolkit | bool

- name: Write NVIDIA Container Toolkit apt repository file
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/nvidia-container-toolkit.list
    content: "{{ nvidia_repo_list.stdout }}\n"
    mode: "0644"
  when: enable_nvidia_container_toolkit | bool

- name: Install NVIDIA Container Toolkit
  ansible.builtin.apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: true
  when: enable_nvidia_container_toolkit | bool

- name: Configure Docker runtime for NVIDIA toolkit
  ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
  register: nvidia_ctk_configure
  changed_when: >-
    'updated' in (nvidia_ctk_configure.stdout | lower)
    or 'updated' in (nvidia_ctk_configure.stderr | lower)
  when: enable_nvidia_container_toolkit | bool

- name: Restart Docker after NVIDIA runtime configuration
  ansible.builtin.service:
    name: docker
    state: restarted
  when:
    - enable_nvidia_container_toolkit | bool
    - nvidia_ctk_configure is changed
